---
title: 'Becas al extranjero CONACYT: una radiograf√≠a (Parte I)'
authors: Manuel Toral
date: '2021-10-02'
categories:
- R
- educaci√≥n
tags:
- bases perronas
- wrangling
- tutoriales
- excel
- bases p√∫blicas
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = T)
```

Muchas veces pa√≠ses como el m√≠o, M√©xico, adolecen de falta de informaci√≥n sobre c√≥mo y en qu√© se gasta el dinero del gobierno. Esc√°ndalo tras esc√°ndalo se fragua en la discusi√≥n p√∫blica sin que haya una perspectiva m√°s amplia, nunca objetiva, de los temas en cuesti√≥n. Es por eso que es alentador que haya informaci√≥n disponible para resolver y entender un contexto.

Recientemente, el hilo de un periodista en twitter acus√≥ a la hija de la Jefa de Gobierno de la Ciudad de M√©xico de haber recibido un mont√≥n de dinero para estudiar en el extranjero. La discusi√≥n, lejos de aportar evidencias de si era un monto com√∫n o si hay m√°s personas estudiando en el mismo campo de estudios, se centr√≥ en lo ya comunes duelos a muerte de acusaciones sin fundamento y argumentos sobre las personas.

Es casi una verdad de perogrullo que el lenguaje es la expresi√≥n del conflicto pol√≠tico y, ni modo, as√≠ es el debate de los temas p√∫blicos en redes, un poquito morbo, un poquito de superioridad moral y por ah√≠ una oportunidad para pavonearse en los datos. No obstante, una de las consecuencias negativas es que, desde mi mera observaci√≥n, pareciera quedarse la idea de que est√° mal recibir una beca en general y, peor, que esta sea de un monto muy abultado. 

Es por eso que hago este breve post con un an√°lisis bastante somero de una fuente interesante de informaci√≥n: el [Padr√≥n de Beneficiarios del CONACyT](https://conacyt.mx/becas_posgrados/padron-de-beneficiarios/) (Consejo Nacional de Ciencia y Tecnolog√≠a).


## Bibliotecas

Para este ejercicio voy a usar la navaja suiza del `tidyverse`, `readxl` para usar los archivos de *MS Excel* ü§¢ü§Æü§° y algunos paquetes para enchular las vizes y usar geometr√≠as como los *treemaps*.

<p>&nbsp;</p> 

<p>&nbsp;</p> 

```{r bibliotecas}
pacman::p_load(tidyverse, #navaja suiza
               tidytext, # Por si se ocupa algo de texto
               janitor, # paquete maravilloso para limpieza
               readxl, # para esa dolorosa tarea
               treemapify, # Para usar treemaps
               ggalt, # Otras geometr√≠as!
               extrafont, # Para importar fuentes
               wesanderson, # Mi paleta favorita
               viridis) #Los colores ya cl√°sicos de viridis
```


# Datos

Las tablas que voy a usar se encuentran en [este sitio web p√∫blico](https://conacyt.mx/becas_posgrados/padron-de-beneficiarios/) del CONACyT. Este sitio tiene un servicio denominado *Incapsula* que previene de su raspado (*scraping*) convencional as√≠ que decid√≠ no complicarme la vida descargar todos los archivos con un ["descargador masivo"](https://chrome.google.com/webstore/detail/simple-mass-downloader/abdkkegmcbiomijcbdaodaflgehfffed).

<p>&nbsp;</p> 


Es posible descargar 54 archivos en formato `.xls` ü§¢ü§Æ con distintos tipo de informaci√≥n elaborados por la Direcci√≥n Adjunta de Posgrados y Becas: personas beneficiadas por becas nacionales y al extranjero, estancias posdocotrales, sab√°ticas y "postdoctorales COVID-19", repatriaciones y retenciones, tabuladores, entre otras, de 2012 a junio de 2020. En este art√≠culo me concentrar√© en un viejo conocido en mi vida: las becas al extranjero. Adem√°s, no usar√© s√≥lo los a√±os completos, es decir, no utilizar√© el archivo del parcial a enero - junio de 2021.

<p>&nbsp;</p> 

En 2015 quien le escribe fue beneficiario de este programa, por lo que fue interesante descubrir mi nombre y el monto en que les mexicanes me apoyaron cuando estudi√© en la Universidad de Chicago.

<p>&nbsp;</p> 

As√≠ pues, decid√≠ leer los archivos en una lista y comenzar a limpiar y ordenar... porque Excel ü§¢ü§Æ. Algunos problemas:

<p>&nbsp;</p> 

- La estructura de las tablas de cada archivo no son consistentes. Difieren en nombre y posici√≥n.
- Dadas las condiciones del punto anterior, no todas las tablas recuperan el monto total en un campo con el mismo nombre, pero s√≠ en la misma posici√≥n.
- Las fechas en Excel son una monserga. En este caso, algunas observaciones se importaron como la conversi√≥n num√©rica de la fecha y otras como un texto con la expresi√≥n convencional. No s√© ustedes, pero este escenario me ocurre muy a menudo y me parece una pesadilla. Lo peor: esto s√≥lo ocurre en algunos archivos: 2020, 2013 y 2014.




<p>&nbsp;</p> 
<p>&nbsp;</p> 

## Limpieza y Homologaci√≥n

Primero lo primero, necesito que todas las tablas de los archivos tengan la misma forma y sus campos tengan la misma clase, para este fin utilizar√© la funci√≥n `lapply` que me permite hacer un blucle cuyo resultado es una lista. En este caso, cada una de las tablas de cada uno de los archivos de Becas en el Extranjero.

<p>&nbsp;</p> 

Por el momento no voy a utilizar la variable que identifica el sexo de la persona toda vez que s√≥lo aparece en 2019, 2020 y en el parcial de 2021. 

<p>&nbsp;</p> 
<p>&nbsp;</p> 


```{r lectura, message=FALSE, warning=FALSE}
archivos <- list.files("input", full.names = T) # Localizo los archivos

nombres_archivos <- archivos %>% # Le pongo nombre a cada tabla
  str_extract("\\d{4}")          # con el a√±o correspondiente.

nombres_campos <- c( # Homologo el nombre de los campos.
  "consec", "inicio_de_beca", "termino_de_beca", "nivel_de_estudios",
  "institucion", "pais", "programa_de_estudios", "area_del_conocimiento",
  "monto_anual"
)

lista_xls <- lapply(archivos, function(x){
  read_excel(x, skip = 2) %>% # 1. Leo
    clean_names() %>% # 2. Limpio los nombre complicados
    filter(!is.na(consec)) %>% # 3. Quito las observaciones vac√≠as 
    select(-starts_with("x")) %>% # 4. Borro que empiecen con "x"
    select(c(1,3:9, ncol(.))) %>% # 5. Variables de inter√©s.
    set_names(nombres_campos) %>% # 6 Homologo el nombre de los campos
    mutate(area_del_conocimiento =
             str_remove(area_del_conocimiento, 
                        "\\b[A-Z]{2,3}\\. ")) %>% 
  # 7. Quito los molestos n√∫meros romanos que cambian a√±o con a√±o.    
    mutate(pais = str_replace(pais, "REP. DE COREA", "COREA"),
           pais = str_replace(pais, "HOLANDA|PAISES BAJOS", "PA√çSES BAJOS"),
           pais = str_to_title(pais)) %>% 
    mutate(institucion = str_to_title(institucion),
           institucion = str_replace(institucion, "Of", "of"),
           institucion = str_replace(institucion, "De", "de"))

})

names(lista_xls) <- nombres_archivos

```

<p>&nbsp;</p> 
<p>&nbsp;</p> 


## Arreglar las fechas

Voy a utilizar un *old fashined* blucle del tipo `for` para especificar qu√© objetos de mi lista voy a modificar. En aquellos objetos que ya se importaron correctamente, conservar√© esa propiedad y tranformar√© en el formato fecha convencional.

<p>&nbsp;</p> 

En aquellos donde Excel hizo su magia, voy a convertir aquellas observaciones que est√°n expresadas en n√∫meros de Excel y convertirlos a fechas.

<p>&nbsp;</p> 

```{r fechas, warning=F, message=F}

# Fechas mal :)


for(i in names(lista_xls)[c(1:3,5,6,9)]) {
  lista_xls[[i]] <- lista_xls[[i]] %>% 
    mutate(inicio_de_beca = as.Date(inicio_de_beca),
           termino_de_beca = as.Date(termino_de_beca ))
}

# Fechas mal :(


for(i in names(lista_xls)[-c(1:3,5,6,9)]) {
  lista_xls[[i]] <- lista_xls[[i]] %>% 
    mutate(inicio_de_beca = case_when(
      str_detect(inicio_de_beca, "\\b[0-9]{5}") ~ 
        as.Date(as.numeric(inicio_de_beca), origin = "1899-12-30"),
      TRUE ~ as.Date(inicio_de_beca, "%d/%m/%Y")
    ))  %>% 
    mutate(termino_de_beca = case_when(
      str_detect(termino_de_beca, "\\b[0-9]{5}") ~ 
        as.Date(as.numeric(termino_de_beca), origin = "1899-12-30"),
      TRUE ~ as.Date(termino_de_beca, "%d/%m/%Y")
    ))
}

```

<p>&nbsp;</p> 

## Unir todo... finalmente

<p>&nbsp;</p> 

```{r}

completa <- bind_rows(lista_xls, .id="yr")

```

<p>&nbsp;</p> 
<p>&nbsp;</p> 

## Deflactar

Para comparar los montos en la variable `monto anual` es necesario convertir los pesos nominales a pesos reales. Utilizar√© el [*Deflactor Impl√≠cito del PIB*](https://fundar.org.mx/wp-content/uploads/2021/09/100-2022-incl..pdf) de FUNDAR.

<p>&nbsp;</p> 
<p>&nbsp;</p> 

```{r}
deflactor <- tibble(
  yr = as.character(seq(2012,2020,1)),
  base_def = c(72.41259032, 73.5179316,76.77470131, 
                78.94867789, 83.35039752, 88.97363649,
                93.37181906,  97.24518037, 100)
  )

completa <- completa %>% 
  left_join(deflactor) %>% 
  mutate(monto_real_20 = monto_anual*(100/base_def))
```

<p>&nbsp;</p> 
<p>&nbsp;</p> 

# Algunos an√°lisis

## Las becas CONACyT al extranjero en el tiempo

Ahora s√≠, despu√©s de todo este merequetengue, estamos listes para hacer algunos an√°lisis. Por ejemplo, el monto que al final del a√±o se erog√≥ a las becas. Al menos de estas tablas, vemos un descenso en los montos finales en los √∫ltimos a√±os.

<p>&nbsp;</p> 
<p>&nbsp;</p> 

```{r}
completa %>% 
  group_by(yr) %>% 
  summarise(suma = sum(monto_real_20)) %>%
  ungroup() %>% 
  ggplot(aes(yr, suma/1000000000, group = 1)) +
  geom_line(size=1.2) +
  geom_point(aes(color = suma), size=4) +
  labs(x = "A√±o", y="Miles de millones de pesos (base 2020)\n",
       title="Montos totales erogados para Becas CONACYT al extranjero",
       caption = "@jmtoralc | Padr√≥n de Beneficiarios | Direcci√≥n Adjunta de Posgrados y Becas de CONACyT") +
  hrbrthemes::theme_ipsum(grid = "Y") +
  scale_y_continuous(limits = c(1, 2.6),
                     breaks = seq(1,2.5,.5),
                     labels = seq(1,2.5,.5)) +
  guides(color ="none") +
  scale_color_gradientn(colors = wesanderson::wes_palette("Zissou1", 5, "continuous"))
```

<p>&nbsp;</p> 
<p>&nbsp;</p> 

Estos montos no necesariamente se traducen en personas, pero siguen una tendencia similar. Por ejemplo, si s√≥lo estudiamos el n√∫mero de personas que recibieron este beneficio vemos una tendencia similar en los √∫ltimos a√±os.

<p>&nbsp;</p> 
<p>&nbsp;</p> 

```{r}
completa %>% 
  group_by(yr) %>% 
  summarise(suma = n()) %>%
  ungroup() %>% 
  ggplot(aes(yr, suma/1000, group = 1)) +
  geom_line(size=1.2) +
  geom_point(aes(color = suma), size=4) +
  labs(x = "A√±o", y="Miles de personas\n",
       title="Personas beficiadas con Becas CONACYT al extranjero",
       caption = "@jmtoralc | Padr√≥n de Beneficiarios | Direcci√≥n Adjunta de Posgrados y Becas de CONACyT") +
  hrbrthemes::theme_ipsum(grid = "Y") +
  scale_y_continuous(limits = c(3, 8),
                     breaks = seq(3,8,1),
                     labels = seq(3,8,1)) +
  guides(color ="none") +
  scale_color_gradientn(colors = wesanderson::wes_palette("Zissou1", 5, "continuous"))
```

<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 

## Las universidades con m√°s estudiantes

```{r, fig.width= 15, fig.height=10}
completa %>% 
  group_by(yr, institucion) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  top_n(10) %>%
  ungroup %>% 
  left_join(completa %>% distinct(yr, institucion, pais)) %>% 
  mutate(yr = as.factor(yr),
         order = reorder_within(institucion, n, yr)) %>%
  ggplot(aes(order, 
             n,
             color = pais)) +
  geom_lollipop(size=2) +
  coord_flip() + 
  facet_wrap(~yr, scales = "free", ncol = 3)+
  hrbrthemes::theme_ipsum(grid = "") +
  scale_x_reordered() +
  scale_color_brewer(name = "Pa√≠s",
                     palette ="Set1",
                     direction = -1) +
  labs(title = "Las 10 Universidades con m√°s estudiantes becados",
       subtitle = "por pa√≠s y a√±o", 
       x = "Instituci√≥n",
       y = "N√∫mero de estudiantes",
       caption = "@jmtoralc | Padr√≥n de Beneficiarios | Direcci√≥n Adjunta de Posgrados y Becas de CONACyT") +
  theme(axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20))
```

<p>&nbsp;</p> 
<p>&nbsp;</p> 

## Las universidades en las que se ha invertido m√°s dinero

```{r, fig.width= 15, fig.height=10}
completa %>% 
  group_by(yr, institucion) %>% 
  summarise(n = sum(monto_real_20)) %>% 
  arrange(-n) %>% 
  top_n(10) %>%
  ungroup %>% 
  left_join(completa %>% distinct(yr, institucion, pais)) %>% 
  mutate(yr = as.factor(yr),
         order = reorder_within(institucion, n, yr)) %>%
  ggplot(aes(order, 
             n/1000000,
             color = pais)) +
  geom_lollipop(size=2) +
  coord_flip() + 
  facet_wrap(~yr, scales = "free", ncol = 3)+
  hrbrthemes::theme_ipsum(grid = "") +
  scale_x_reordered() +
  scale_color_brewer(name = "Pa√≠s",
                     palette ="Dark2",
                     direction = -1) +
  labs(title = "Las 10 Universidades con m√°s dinero recibido",
       subtitle = "por concepto de becas CONACYT, por pa√≠s y a√±o", 
       x = "Instituci√≥n",
       y = "Millones de pesos (base 2020)",
       caption = "@jmtoralc | Padr√≥n de Beneficiarios | Direcci√≥n Adjunta de Posgrados y Becas de CONACyT")  +
  theme(axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20))

```

<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 

# Datos sobre la sesi√≥n

```{r}
sessionInfo()
```

